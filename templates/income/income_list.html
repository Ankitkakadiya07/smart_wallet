{% extends 'base.html' %}
{% load static %}

{% block title %}Income Management - Smart Wallet{% endblock %}

{% block extra_css %}
<style>
  .income-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
  }

  .income-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .income-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .table-responsive {
    border-radius: 15px;
    overflow: hidden;
  }

  .table th {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .table th:hover {
    background: linear-gradient(135deg, #20c997, #28a745);
  }

  .table th.sortable::after {
    content: ' ⇅';
    opacity: 0.5;
  }

  .table th.sort-asc::after {
    content: ' ↑';
    opacity: 1;
    color: #ffc107;
  }

  .table th.sort-desc::after {
    content: ' ↓';
    opacity: 1;
    color: #ffc107;
  }

  .table tbody tr {
    transition: all 0.3s ease;
  }

  .table tbody tr:hover {
    background-color: rgba(40, 167, 69, 0.05);
    transform: scale(1.01);
  }

  .amount-cell {
    font-weight: bold;
    font-size: 1.1rem;
  }

  .category-badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
  }

  .action-buttons .btn {
    margin: 0 2px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .action-buttons .btn:hover {
    transform: translateY(-2px);
  }

  .add-income-btn {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    border-radius: 25px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
  }

  .add-income-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
  }

  .stats-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    border: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .stats-icon {
    font-size: 2.5rem;
    color: #28a745;
    margin-bottom: 1rem;
  }

  .fade-in {
    animation: fadeIn 0.8s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile responsive adjustments */
  @media (max-width: 768px) {
    .income-header {
      padding: 1.5rem;
      text-align: center;
    }

    .table-responsive {
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .action-buttons .btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
    }

    .stats-card {
      margin-bottom: 1rem;
    }
  }

  @media (max-width: 576px) {

    .table th,
    .table td {
      padding: 0.5rem 0.25rem;
      font-size: 0.8rem;
    }

    .amount-cell {
      font-size: 1rem;
    }

    .category-badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
  <!-- Header Section -->
  <div class="income-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="mb-2">
          <i class="fas fa-arrow-up me-3"></i>Income Management
        </h1>
        <p class="mb-0 opacity-90">
          Track and manage all your income sources in one place
        </p>
      </div>
      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        <a href="{% url 'wallet:income_create' %}" class="btn btn-light add-income-btn">
          <i class="fas fa-plus me-2"></i>Add New Income
        </a>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card">
        <div class="stats-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <h4 class="text-success mb-1">${{ total_income|floatformat:2 }}</h4>
        <small class="text-muted">Total Income</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card">
        <div class="stats-icon">
          <i class="fas fa-list"></i>
        </div>
        <h4 class="text-primary mb-1">{{ income_list|length }}</h4>
        <small class="text-muted">Total Transactions</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card">
        <div class="stats-icon">
          <i class="fas fa-calendar"></i>
        </div>
        <h4 class="text-info mb-1">
          {% if income_list %}
          {{ income_list.0.date|date:"M Y" }}
          {% else %}
          N/A
          {% endif %}
        </h4>
        <small class="text-muted">Latest Entry</small>
      </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
      <div class="card stats-card">
        <div class="stats-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <h4 class="text-warning mb-1">
          {% if income_list %}
          ${{ income_list.0.amount|floatformat:2 }}
          {% else %}
          $0.00
          {% endif %}
        </h4>
        <small class="text-muted">Latest Amount</small>
      </div>
    </div>
  </div>

  <!-- Search and Filter Section -->
  <div class="card mb-4">
    <div class="card-header bg-transparent border-0 py-3">
      <h5 class="mb-0">
        <i class="fas fa-search me-2"></i>Search & Filter
        <button class="btn btn-sm btn-outline-secondary ms-2" type="button" data-bs-toggle="collapse"
          data-bs-target="#searchFilters" aria-expanded="false">
          <i class="fas fa-filter me-1"></i>Filters
        </button>
      </h5>
    </div>
    <div class="card-body">
      <form method="GET" id="search-form" class="row g-3">
        <!-- Search Input -->
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" name="search" value="{{ search_query }}"
              placeholder="Search by source, note, or category..." accesskey="s"
              title="Press Alt+S to focus (Ctrl+S on Mac)">
            <button class="btn btn-outline-secondary" type="button" id="clear-search" title="Clear search">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <!-- Quick Search Buttons -->
        <div class="col-md-8">
          <div class="btn-group btn-group-sm me-2" role="group">
            <button type="button" class="btn btn-outline-success quick-search" data-search="salary">Salary</button>
            <button type="button" class="btn btn-outline-success quick-search" data-search="business">Business</button>
            <button type="button" class="btn btn-outline-success quick-search"
              data-search="freelance">Freelance</button>
          </div>
          <button type="submit" class="btn btn-success btn-sm">
            <i class="fas fa-search me-1"></i>Search
          </button>
          <a href="{% url 'wallet:income_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-undo me-1"></i>Reset
          </a>
        </div>

        <!-- Advanced Filters (Collapsible) -->
        <div class="collapse" id="searchFilters">
          <div class="row g-3 mt-2 pt-3 border-top">
            <div class="col-md-3">
              <label class="form-label">Category</label>
              <select name="category" class="form-select form-select-sm">
                <option value="">All Categories</option>
                {% for category in categories %}
                <option value="{{ category.name }}" {% ifequal category_filter category.name %}selected{% endifequal %}>
                  {{ category.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Date From</label>
              <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Date To</label>
              <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Amount Range</label>
              <div class="input-group input-group-sm">
                <input type="number" name="amount_min" class="form-control" placeholder="Min" value="{{ amount_min }}"
                  step="0.01">
                <span class="input-group-text">-</span>
                <input type="number" name="amount_max" class="form-control" placeholder="Max" value="{{ amount_max }}"
                  step="0.01">
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Income Table -->
  <div class="card income-card">
    <div class="card-header bg-transparent border-0 py-3">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>Income Transactions
            {% if search_query or category_filter or date_from or date_to or amount_min or amount_max %}
            <span class="badge bg-info ms-2">Filtered</span>
            {% endif %}
          </h5>
        </div>
        <div class="col-md-6 text-md-end mt-2 mt-md-0">
          <div class="btn-group btn-group-sm me-2" role="group">
            <button type="button" class="btn btn-outline-success" id="sort-date" title="Sort by Date (Ctrl+D)"
              accesskey="d">
              <i class="fas fa-calendar me-1"></i>Date
            </button>
            <button type="button" class="btn btn-outline-success" id="sort-amount" title="Sort by Amount (Ctrl+A)"
              accesskey="a">
              <i class="fas fa-dollar-sign me-1"></i>Amount
            </button>
            <button type="button" class="btn btn-outline-success" id="refresh-table" title="Refresh Table (Ctrl+R)"
              accesskey="r">
              <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
          </div>
          <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown"
              title="Export Data (Ctrl+E)" accesskey="e">
              <i class="fas fa-download me-1"></i>Export
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item export-link" href="{% url 'wallet:export_data' %}?type=income"
                  data-type="income">
                  <i class="fas fa-file-csv me-2"></i>Income CSV
                </a></li>
              <li><a class="dropdown-item export-link" href="{% url 'wallet:export_data' %}?type=all" data-type="all">
                  <i class="fas fa-file-csv me-2"></i>All Transactions CSV
                </a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="card-body p-0">
      {% if income_list %}
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="income-table">
          <thead>
            <tr>
              <th class="sortable" data-sort="date">
                <i class="fas fa-calendar me-2"></i>Date
              </th>
              <th class="sortable" data-sort="category">
                <i class="fas fa-tag me-2"></i>Category
              </th>
              <th class="sortable" data-sort="source">
                <i class="fas fa-building me-2"></i>Source
              </th>
              <th class="sortable" data-sort="amount">
                <i class="fas fa-dollar-sign me-2"></i>Amount
              </th>
              <th>
                <i class="fas fa-sticky-note me-2"></i>Note
              </th>
              <th class="text-center">
                <i class="fas fa-cogs me-2"></i>Actions
              </th>
            </tr>
          </thead>
          <tbody id="income-tbody">
            {% for income in income_list %}
            <tr class="income-row" data-id="{{ income.id }}">
              <td>
                <div class="fw-bold">{{ income.date|date:"M d, Y" }}</div>
                <small class="text-muted">{{ income.date|date:"l" }}</small>
              </td>
              <td>
                <span class="badge category-badge bg-success">
                  {{ income.category.name }}
                </span>
              </td>
              <td>
                <div class="fw-bold">{{ income.source }}</div>
                <small class="text-muted">
                  <i class="fas fa-clock me-1"></i>
                  {{ income.created_at|date:"M d, Y g:i A" }}
                </small>
              </td>
              <td class="amount-cell text-success">
                +${{ income.amount|floatformat:2 }}
              </td>
              <td>
                {% if income.note %}
                <span class="text-info" title="{{ income.note }}">
                  {{ income.note|truncatechars:30 }}
                </span>
                {% else %}
                <span class="text-muted">No note</span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="action-buttons">
                  <a href="{% url 'wallet:income_update' income.pk %}" class="btn btn-outline-primary btn-sm"
                    title="Edit Income" data-bs-toggle="tooltip">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'wallet:income_delete' income.pk %}" class="btn btn-outline-danger btn-sm"
                    title="Delete Income" data-bs-toggle="tooltip">
                    <i class="fas fa-trash"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <!-- Empty State -->
      <div class="text-center py-5">
        <div class="mb-4">
          <i class="fas fa-inbox fa-4x text-muted"></i>
        </div>
        <h4 class="text-muted mb-3">No Income Transactions Yet</h4>
        <p class="text-muted mb-4">
          Start tracking your income by adding your first transaction.
        </p>
        <a href="{% url 'wallet:income_create' %}" class="btn btn-success btn-lg">
          <i class="fas fa-plus me-2"></i>Add Your First Income
        </a>
      </div>
      {% endif %}
    </div>

    {% if income_list %}
    <div class="card-footer bg-transparent border-0 py-3">
      <div class="row align-items-center">
        <div class="col-md-4">
          <small class="text-muted">
            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ filtered_count }} transaction{{
            filtered_count|pluralize }}
            {% if total_income != 0 %}
            <br>Filtered Total: <strong class="text-success">${{ total_income|floatformat:2 }}</strong>
            {% endif %}
          </small>
        </div>
        <div class="col-md-4 text-center">
          {% if is_paginated %}
          <nav aria-label="Income pagination">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                  href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1"
                  title="First Page (Ctrl+Home)" accesskey="h">
                  <i class="fas fa-angle-double-left"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link"
                  href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}"
                  title="Previous Page (Ctrl+Left)">
                  <i class="fas fa-angle-left"></i>
                </a>
              </li>
              {% endif %}

              {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item">
                <a class="page-link"
                  href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{
                  num }}</a>
                </li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link"
                    href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}"
                    title="Next Page (Ctrl+Right)">
                    <i class="fas fa-angle-right"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link"
                    href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}"
                    title="Last Page (Ctrl+End)" accesskey="l">
                    <i class="fas fa-angle-double-right"></i>
                  </a>
                </li>
                {% endif %}
            </ul>
          </nav>
          {% endif %}
        </div>
        <div class="col-md-4 text-md-end mt-2 mt-md-0">
          <a href="{% url 'wallet:dashboard' %}" class="btn btn-outline-secondary btn-sm me-2"
            title="Back to Dashboard (Ctrl+B)" accesskey="b">
            <i class="fas fa-arrow-left me-1"></i>Back
          </a>
          <a href="{% url 'wallet:income_create' %}" class="btn btn-success btn-sm" title="Add New Income (Ctrl+N)"
            accesskey="n">
            <i class="fas fa-plus me-1"></i>Add Income
          </a>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize advanced UI features
    initializeAdvancedFeatures();
    initializeKeyboardShortcuts();
    initializeAccessibility();
    initializeSearch();
    initializeExport();

    // Initialize existing functionality
    initializeTooltips();
    initializeTableSorting();
    initializeTableActions();
  });

  function initializeAdvancedFeatures() {
    // Quick search buttons
    document.querySelectorAll('.quick-search').forEach(btn => {
      btn.addEventListener('click', function () {
        const searchTerm = this.dataset.search;
        const searchInput = document.querySelector('input[name="search"]');
        searchInput.value = searchTerm;
        document.getElementById('search-form').submit();
      });
    });

    // Clear search button
    document.getElementById('clear-search')?.addEventListener('click', function () {
      const searchInput = document.querySelector('input[name="search"]');
      searchInput.value = '';
      searchInput.focus();
    });

    // Auto-submit search form on Enter
    document.querySelector('input[name="search"]')?.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('search-form').submit();
      }
    });

    // Real-time search suggestions (debounced)
    let searchTimeout;
    document.querySelector('input[name="search"]')?.addEventListener('input', function () {
      clearTimeout(searchTimeout);
      const query = this.value.trim();

      if (query.length >= 2) {
        searchTimeout = setTimeout(() => {
          showSearchSuggestions(query);
        }, 300);
      } else {
        hideSearchSuggestions();
      }
    });
  }

  function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function (e) {
      // Check if user is typing in an input field
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }

      // Keyboard shortcuts
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 'f':
          case 'F':
            e.preventDefault();
            document.querySelector('input[name="search"]').focus();
            break;
          case 'n':
          case 'N':
            e.preventDefault();
            window.location.href = '{% url "wallet:income_create" %}';
            break;
          case 'e':
          case 'E':
            e.preventDefault();
            document.querySelector('.dropdown-toggle[title*="Export"]').click();
            break;
          case 'r':
          case 'R':
            e.preventDefault();
            document.getElementById('refresh-table').click();
            break;
          case 'b':
          case 'B':
            e.preventDefault();
            window.location.href = '{% url "wallet:dashboard" %}';
            break;
          case 'Home':
            e.preventDefault();
            document.querySelector('a[accesskey="h"]')?.click();
            break;
          case 'End':
            e.preventDefault();
            document.querySelector('a[accesskey="l"]')?.click();
            break;
        }
      }

      // Arrow key navigation for pagination
      if (e.ctrlKey) {
        switch (e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            document.querySelector('.page-link[title*="Previous"]')?.click();
            break;
          case 'ArrowRight':
            e.preventDefault();
            document.querySelector('.page-link[title*="Next"]')?.click();
            break;
        }
      }

      // Escape key to clear search
      if (e.key === 'Escape') {
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput.value) {
          searchInput.value = '';
          hideSearchSuggestions();
        }
      }
    });
  }

  function initializeAccessibility() {
    // Add ARIA labels and roles
    const table = document.getElementById('income-table');
    if (table) {
      table.setAttribute('role', 'table');
      table.setAttribute('aria-label', 'Income transactions table');
    }

    // Add screen reader announcements for dynamic content
    const searchForm = document.getElementById('search-form');
    if (searchForm) {
      searchForm.setAttribute('role', 'search');
      searchForm.setAttribute('aria-label', 'Search and filter income transactions');
    }

    // Announce filter changes to screen readers
    const filterInputs = document.querySelectorAll('#search-form input, #search-form select');
    filterInputs.forEach(input => {
      input.addEventListener('change', function () {
        announceToScreenReader(`Filter updated: ${this.name} set to ${this.value}`);
      });
    });

    // Focus management for modals and dropdowns
    document.addEventListener('shown.bs.collapse', function (e) {
      const firstInput = e.target.querySelector('input, select');
      if (firstInput) {
        firstInput.focus();
      }
    });
  }

  function initializeSearch() {
    // Advanced search functionality
    let searchCache = new Map();

    window.performAdvancedSearch = function (query, type = 'income') {
      if (searchCache.has(query)) {
        displaySearchResults(searchCache.get(query));
        return;
      }

      fetch(`/api/search/?q=${encodeURIComponent(query)}&type=${type}&limit=10`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            searchCache.set(query, data.results);
            displaySearchResults(data.results);
          }
        })
        .catch(error => {
          console.error('Search error:', error);
        });
    };
  }

  function initializeExport() {
    // Enhanced export functionality
    document.querySelectorAll('.export-link').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();

        const exportType = this.dataset.type;
        const url = new URL(this.href);

        // Add current filter parameters to export
        const searchParams = new URLSearchParams(window.location.search);
        ['search', 'category', 'date_from', 'date_to', 'amount_min', 'amount_max'].forEach(param => {
          const value = searchParams.get(param);
          if (value) {
            url.searchParams.set(param, value);
          }
        });

        // Show export progress
        showExportProgress(exportType);

        // Create hidden link and trigger download
        const downloadLink = document.createElement('a');
        downloadLink.href = url.toString();
        downloadLink.download = '';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        // Hide progress after delay
        setTimeout(() => hideExportProgress(), 2000);
      });
    });
  }

  function showSearchSuggestions(query) {
    // Create or update search suggestions dropdown
    let suggestionsContainer = document.getElementById('search-suggestions');

    if (!suggestionsContainer) {
      suggestionsContainer = document.createElement('div');
      suggestionsContainer.id = 'search-suggestions';
      suggestionsContainer.className = 'position-absolute bg-white border rounded shadow-sm w-100 mt-1';
      suggestionsContainer.style.zIndex = '1000';

      const searchInput = document.querySelector('input[name="search"]');
      searchInput.parentElement.style.position = 'relative';
      searchInput.parentElement.appendChild(suggestionsContainer);
    }

    // Perform search and show suggestions
    performAdvancedSearch(query, 'income');
  }

  function displaySearchResults(results) {
    const suggestionsContainer = document.getElementById('search-suggestions');
    if (!suggestionsContainer) return;

    if (results.length === 0) {
      suggestionsContainer.innerHTML = '<div class="p-2 text-muted">No suggestions found</div>';
      return;
    }

    const html = results.slice(0, 5).map(result => `
      <div class="p-2 border-bottom suggestion-item" style="cursor: pointer;" data-url="${result.url}">
        <div class="fw-bold">${result.title}</div>
        <small class="text-muted">${result.category} • $${result.amount} • ${formatDate(result.date)}</small>
      </div>
    `).join('');

    suggestionsContainer.innerHTML = html;

    // Add click handlers to suggestions
    suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
      item.addEventListener('click', function () {
        window.location.href = this.dataset.url;
      });
    });
  }

  function hideSearchSuggestions() {
    const suggestionsContainer = document.getElementById('search-suggestions');
    if (suggestionsContainer) {
      suggestionsContainer.remove();
    }
  }

  function showExportProgress(type) {
    const progressHtml = `
      <div id="export-progress" class="position-fixed top-50 start-50 translate-middle bg-white p-4 rounded shadow" style="z-index: 1060;">
        <div class="text-center">
          <i class="fas fa-download fa-2x text-primary mb-3"></i>
          <h5>Exporting ${type} data...</h5>
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', progressHtml);
  }

  function hideExportProgress() {
    const progress = document.getElementById('export-progress');
    if (progress) {
      progress.remove();
    }
  }

  function announceToScreenReader(message) {
    const announcement = document.createElement('div');
    announcement.setAttribute('aria-live', 'polite');
    announcement.setAttribute('aria-atomic', 'true');
    announcement.className = 'sr-only';
    announcement.textContent = message;

    document.body.appendChild(announcement);
    setTimeout(() => document.body.removeChild(announcement), 1000);
  }

  function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  }

  // Initialize existing functionality
  function initializeTooltips() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  }

  function initializeTableSorting() {
    const table = document.getElementById('income-table');
    const tbody = document.getElementById('income-tbody');

    if (table && tbody) {
      let sortDirection = {};

      document.querySelectorAll('th.sortable').forEach(header => {
        header.addEventListener('click', function () {
          const sortKey = this.dataset.sort;
          sortTable(sortKey);
        });
      });

      function sortTable(sortKey) {
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const currentDirection = sortDirection[sortKey] || 'asc';
        const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';

        sortDirection[sortKey] = newDirection;

        document.querySelectorAll('th.sortable').forEach(th => {
          th.classList.remove('sort-asc', 'sort-desc');
        });
        document.querySelector(`th[data-sort="${sortKey}"]`).classList.add(`sort-${newDirection}`);

        rows.sort((a, b) => {
          let aVal, bVal;

          switch (sortKey) {
            case 'date':
              aVal = new Date(a.cells[0].querySelector('.fw-bold').textContent);
              bVal = new Date(b.cells[0].querySelector('.fw-bold').textContent);
              break;
            case 'category':
              aVal = a.cells[1].textContent.trim();
              bVal = b.cells[1].textContent.trim();
              break;
            case 'source':
              aVal = a.cells[2].querySelector('.fw-bold').textContent;
              bVal = b.cells[2].querySelector('.fw-bold').textContent;
              break;
            case 'amount':
              aVal = parseFloat(a.cells[3].textContent.replace(/[+$,]/g, ''));
              bVal = parseFloat(b.cells[3].textContent.replace(/[+$,]/g, ''));
              break;
            default:
              aVal = a.cells[0].textContent;
              bVal = b.cells[0].textContent;
          }

          if (newDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });

        rows.forEach(row => tbody.appendChild(row));

        rows.forEach((row, index) => {
          row.style.animation = 'none';
          setTimeout(() => {
            row.style.animation = `fadeIn 0.3s ease-in ${index * 0.05}s both`;
          }, 10);
        });

        announceToScreenReader(`Table sorted by ${sortKey} in ${newDirection}ending order`);
      }
    }
  }

  function initializeTableActions() {
    document.getElementById('sort-date')?.addEventListener('click', () => sortTable('date'));
    document.getElementById('sort-amount')?.addEventListener('click', () => sortTable('amount'));

    document.getElementById('refresh-table')?.addEventListener('click', function () {
      const btn = this;
      const originalContent = btn.innerHTML;

      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
      btn.disabled = true;

      setTimeout(() => {
        btn.innerHTML = originalContent;
        btn.disabled = false;

        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show mt-3';
        alert.innerHTML = `
          <i class="fas fa-check-circle me-2"></i>Table refreshed successfully!
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.card-body').prepend(alert);

        announceToScreenReader('Table refreshed successfully');
        setTimeout(() => alert.remove(), 3000);
      }, 1000);
    });

    document.querySelectorAll('.income-row').forEach(row => {
      row.addEventListener('mouseenter', function () {
        this.style.transform = 'scale(1.01)';
      });

      row.addEventListener('mouseleave', function () {
        this.style.transform = 'scale(1)';
      });
    });
  }
</script>
{% endblock %}